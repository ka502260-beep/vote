<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성수동 고기 원정대 투표</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Pretendard', -apple-system, sans-serif;
        }

        @keyframes slide-in-from-bottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slide-in-from-bottom 0.5s ease-out;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-[#050505] text-white">
    <div id="app"></div>

    <script>
        // 상수 정의 - 5개 업체로 업데이트
        const CANDIDATES = [
            {
                id: 'woohyangga',
                name: '우향가 정육식당',
                description: '전통 한우 전문점',
                url: 'https://naver.me/FmfyIP9z',
                image: 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=400'
            },
            {
                id: 'cheongchun',
                name: '청춘고깃간',
                description: '분위기 좋은 고깃집',
                url: 'https://naver.me/xVBhNmhX',
                image: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400'
            },
            {
                id: 'hyojadong',
                name: '효자동목고기 성수역점',
                description: '목살 전문 맛집',
                url: 'https://naver.me/Fr7ptf0O',
                image: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?w=400'
            },
            {
                id: 'kkotsamddukkeong',
                name: '꽃삼뚜껑 구의역점',
                description: '삼겹살 명가',
                url: 'https://naver.me/GvcT7ewW',
                image: 'https://images.unsplash.com/photo-1602470520998-f4a52199a3d6?w=400'
            },
            {
                id: 'hwagiaae',
                name: '화기애애 본점',
                description: '회식 전문 고깃집',
                url: 'https://naver.me/xiqiGei8',
                image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400'
            }
        ];

        const TOTAL_VOTERS = 7;
        const STORAGE_KEY = 'restaurant_votes_v3';

        // 상태 관리
        const AppState = {
            WELCOME: 'WELCOME',
            RECORDED: 'RECORDED',
            DASHBOARD: 'DASHBOARD',
            FINAL_RESULT: 'FINAL_RESULT'
        };

        // 전역 상태
        let state = {
            step: AppState.WELCOME,
            votes: [],
            aiCommentary: null,
            loadingAi: false,
            syncStatus: 'IDLE',
            votingFor: null,
            myVoteId: localStorage.getItem('voter_id') || null
        };

        // 초기화
        if (!state.myVoteId) {
            state.myVoteId = 'voter_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('voter_id', state.myVoteId);
        }

        // LocalStorage에서 투표 데이터 로드
        function loadVotes() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    state.votes = JSON.parse(stored);
                    
                    // 내가 이미 투표했는지 확인
                    const userVote = state.votes.find(v => v.voterId === state.myVoteId);
                    
                    if (state.votes.length >= TOTAL_VOTERS) {
                        state.step = AppState.FINAL_RESULT;
                        getAiCommentary();
                    } else if (userVote && state.step === AppState.WELCOME) {
                        state.step = AppState.RECORDED;
                    }
                }
            } catch (e) {
                console.error('데이터 로딩 오류:', e);
                state.votes = [];
            }
        }

        // LocalStorage에 투표 데이터 저장
        function saveVotes() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.votes));
                // storage 이벤트 발생 (다른 탭 동기화용)
                window.dispatchEvent(new Event('storage'));
            } catch (e) {
                console.error('데이터 저장 오류:', e);
            }
        }

        // 투표 처리
        function handleRestaurantClick(restaurantId) {
            if (state.votingFor) return;

            // 이미 투표했는지 확인
            if (state.votes.some(v => v.voterId === state.myVoteId)) {
                alert("이미 투표를 완료하셨습니다.");
                state.step = AppState.RECORDED;
                render();
                return;
            }

            // 7명 제한 확인
            if (state.votes.length >= TOTAL_VOTERS) {
                alert("투표가 마감되었습니다.");
                state.step = AppState.FINAL_RESULT;
                render();
                return;
            }

            const restaurant = CANDIDATES.find(c => c.id === restaurantId);
            if (!confirm(`'${restaurant.name}'에 투표하시겠습니까?`)) return;

            state.votingFor = restaurantId;
            render();

            // 투표 저장
            setTimeout(() => {
                const newVote = {
                    voterId: state.myVoteId,
                    restaurantId: restaurantId,
                    timestamp: Date.now()
                };
                
                state.votes.push(newVote);
                saveVotes();

                if (state.votes.length >= TOTAL_VOTERS) {
                    state.step = AppState.FINAL_RESULT;
                    getAiCommentary();
                } else {
                    state.step = AppState.RECORDED;
                }

                state.votingFor = null;
                render();
            }, 500);
        }

        // AI 코멘트 생성
        function getAiCommentary() {
            if (state.aiCommentary) return;
            
            state.loadingAi = true;
            render();

            const winner = getSortedResults()[0];
            
            const comments = [
                `축하합니다! ${winner.name}이(가) ${winner.count}표로 최종 선정되었습니다. 팀원 여러분의 선택이 만장일치에 가까운 결과를 보여주셨네요. 맛있는 식사 되시길 바랍니다!`,
                `${winner.name}이(가) 압도적인 ${winner.count}표를 획득하며 선정되었습니다. 이번 회식은 분명 기억에 남는 시간이 될 것 같습니다. 즐거운 시간 보내세요!`,
                `팀원들의 선택, ${winner.name}! ${winner.count}명의 원정대원이 선택한 이곳에서 특별한 추억을 만들어보세요. 행복한 회식 되시길!`
            ];

            setTimeout(() => {
                state.aiCommentary = comments[Math.floor(Math.random() * comments.length)];
                state.loadingAi = false;
                render();
            }, 1500);
        }

        // 결과 정렬
        function getSortedResults() {
            const counts = {};
            state.votes.forEach(v => {
                counts[v.restaurantId] = (counts[v.restaurantId] || 0) + 1;
            });
            return CANDIDATES.map(c => ({
                ...c,
                count: counts[c.id] || 0
            })).sort((a, b) => b.count - a.count);
        }

        // 식당 이름 가져오기
        function getRestaurantName(id) {
            return CANDIDATES.find(c => c.id === id)?.name || "알 수 없음";
        }

        // 초기화
        function resetAll() {
            if (!confirm('모든 데이터를 초기화하고 다시 시작할까요?')) return;
            
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('voter_id');
            location.reload();
        }

        // UI 렌더링
        function render() {
            const app = document.getElementById('app');
            const results = getSortedResults();
            const winner = results[0];

            app.innerHTML = `
                <div class="min-h-screen bg-[#050505] text-white overflow-x-hidden">
                    <div class="max-w-2xl mx-auto px-6 py-10">
                        
                        <!-- 헤더 -->
                        <header class="flex flex-col items-center mb-8 space-y-6">
                            <div class="flex items-center justify-between w-full">
                                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full border text-[10px] font-black transition-all bg-black/40 border-neutral-800 text-green-500">
                                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                    로컬 저장소 연결됨
                                </div>
                                <button 
                                    onclick="toggleDashboard()"
                                    class="px-4 py-2 bg-neutral-900 border border-neutral-800 rounded-xl text-[11px] font-black hover:border-orange-500 transition-all flex items-center gap-2 tracking-widest uppercase"
                                >
                                    <i class="fas ${state.step === AppState.DASHBOARD ? 'fa-home' : 'fa-chart-pie'}"></i>
                                    ${state.step === AppState.DASHBOARD ? '홈' : '실시간 현황'}
                                </button>
                            </div>
                            <div class="w-20 h-20 bg-gradient-to-tr from-orange-600 to-red-600 rounded-[1.8rem] flex items-center justify-center shadow-2xl shadow-orange-900/40 relative">
                                <i class="fas fa-drumstick-bite text-3xl"></i>
                                <div class="absolute -top-2 -right-2 bg-white text-black w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black shadow-lg">7</div>
                            </div>
                            <div class="text-center">
                                <h1 class="text-3xl font-[900] tracking-tight text-white mb-1">성수동 고기 원정대</h1>
                                <p class="text-neutral-500 text-[10px] font-black uppercase tracking-[0.3em]">Quick & Real-time Voting</p>
                            </div>
                        </header>

                        <!-- 메인 콘텐츠 -->
                        <div class="bg-neutral-900/40 backdrop-blur-3xl rounded-[2.5rem] border border-neutral-800 p-8 shadow-2xl transition-all min-h-[420px] flex flex-col">
                            ${renderContent()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            const results = getSortedResults();
            const winner = results[0];

            if (state.step === AppState.WELCOME) {
                return `
                    <div class="space-y-8 animate-in flex-grow">
                        <div class="text-center">
                            <p class="text-orange-500 text-[10px] font-black mb-2 uppercase tracking-[0.2em]">Step: 1 Click Vote</p>
                            <h2 class="text-2xl font-black text-white">가고 싶은 식당을 고르세요</h2>
                            <p class="text-neutral-500 text-xs mt-2 font-bold italic">터치 즉시 투표 리스트에 반영됩니다.</p>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            ${CANDIDATES.map(c => `
                                <button 
                                    onclick="handleRestaurantClick('${c.id}')"
                                    ${state.votingFor ? 'disabled' : ''}
                                    class="flex items-center gap-4 border p-4 rounded-2xl transition-all text-left group active:scale-[0.98] relative overflow-hidden ${state.votingFor === c.id ? 'bg-orange-500/10 border-orange-500' : 'bg-neutral-800/40 hover:bg-neutral-800 border-neutral-800 hover:border-orange-500/50'}"
                                >
                                    <div class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 border border-neutral-700">
                                        <img src="${c.image}" alt="${c.name}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500" />
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-lg font-black leading-none">${c.name}</span>
                                        </div>
                                        <p class="text-[11px] text-neutral-500 font-medium line-clamp-1">${c.description}</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center bg-neutral-900 group-hover:bg-orange-500/20 group-hover:text-orange-500 transition-colors">
                                        ${state.votingFor === c.id ? '<i class="fas fa-circle-notch animate-spin text-xs"></i>' : '<i class="fas fa-check text-xs"></i>'}
                                    </div>
                                </button>
                            `).join('')}
                        </div>

                        <div class="pt-6 border-t border-neutral-800 flex justify-between items-center">
                            <span class="text-[10px] font-black text-neutral-600 uppercase tracking-widest">투표 참여도</span>
                            <div class="flex items-center gap-3">
                                <div class="w-24 bg-neutral-800 h-1.5 rounded-full overflow-hidden">
                                    <div class="bg-orange-500 h-full transition-all duration-700" style="width: ${(state.votes.length/TOTAL_VOTERS)*100}%"></div>
                                </div>
                                <span class="text-orange-500 font-black text-xs">${state.votes.length} / ${TOTAL_VOTERS}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.step === AppState.RECORDED) {
                return `
                    <div class="py-12 text-center space-y-8 animate-in flex-grow flex flex-col justify-center">
                        <div class="w-24 h-24 bg-green-500/10 border-2 border-green-500 rounded-full flex items-center justify-center mx-auto shadow-[0_0_50px_rgba(34,197,94,0.15)] animate-pulse">
                            <i class="fas fa-receipt text-4xl text-green-500"></i>
                        </div>
                        <div class="space-y-3">
                            <h2 class="text-3xl font-black italic tracking-tighter">SUCCESSFULLY RECORDED</h2>
                            <p class="text-neutral-500 font-bold leading-relaxed text-sm">
                                귀하의 투표가 안전하게 저장되었습니다.<br/>
                                7명이 모두 완료하면 AI 결과 분석이 시작됩니다.
                            </p>
                        </div>
                        <div class="pt-4 px-10">
                            <button onclick="state.step = '${AppState.DASHBOARD}'; render();" class="w-full bg-orange-600 hover:bg-orange-500 py-5 rounded-2xl font-black transition-all uppercase tracking-[0.2em] text-xs shadow-xl shadow-orange-900/20">실시간 득표 순위 보기</button>
                        </div>
                    </div>
                `;
            }

            if (state.step === AppState.DASHBOARD) {
                return `
                    <div class="space-y-8 animate-in">
                        <div class="flex justify-between items-end border-b border-neutral-800 pb-4">
                            <div>
                                <h2 class="text-2xl font-black">실시간 득표 통계</h2>
                                <p class="text-[10px] text-neutral-500 font-black uppercase tracking-widest mt-1">Live Meat-Board</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-black text-neutral-600 mb-1 uppercase tracking-tighter">Total Collected</div>
                                <span class="text-3xl font-black text-orange-500">${state.votes.length}</span>
                                <span class="text-neutral-600 font-black text-xl"> / ${TOTAL_VOTERS}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            ${results.map((res, i) => `
                                <div class="relative bg-neutral-800/20 p-5 rounded-2xl border border-neutral-800 flex justify-between items-center overflow-hidden transition-transform hover:scale-[1.02]">
                                    <div class="absolute left-0 top-0 h-full bg-orange-600/10 transition-all duration-1000" style="width: ${(res.count/Math.max(1, state.votes.length))*100}%"></div>
                                    <div class="relative z-10 flex items-center gap-4">
                                        <span class="w-8 h-8 rounded-xl flex items-center justify-center text-xs font-black ${i === 0 ? 'bg-orange-500 text-white' : 'bg-neutral-800 text-neutral-500'}">${i + 1}</span>
                                        <div>
                                            <span class="font-black text-sm block leading-none mb-1">${res.name}</span>
                                            <div class="w-20 bg-neutral-900 h-1 rounded-full overflow-hidden">
                                                <div class="bg-orange-500/40 h-full" style="width: ${(res.count/TOTAL_VOTERS)*100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="relative z-10 font-black text-xl text-orange-500">${res.count}<span class="text-[10px] ml-1 text-neutral-500 uppercase tracking-tighter">Votes</span></span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-neutral-900/60 p-5 rounded-2xl border border-neutral-800">
                            <p class="text-[10px] font-black text-neutral-600 uppercase tracking-widest mb-4 flex justify-between items-center">
                                <span>최근 활동 로그</span>
                                <span class="text-[8px] bg-neutral-800 px-2 py-0.5 rounded text-neutral-400">LIVE</span>
                            </p>
                            <div class="space-y-3">
                                ${state.votes.length > 0 ? [...state.votes].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5).map((v, i) => `
                                    <div class="flex justify-between items-center text-[11px] font-bold border-l-2 border-orange-500/30 pl-3">
                                        <div class="flex flex-col">
                                            <span class="text-white">익명 원정대원 #${state.votes.length - i}</span>
                                            <span class="text-[9px] text-neutral-600">${new Date(v.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                        <span class="text-orange-500 bg-orange-500/10 px-3 py-1 rounded-lg border border-orange-500/20">${getRestaurantName(v.restaurantId)}</span>
                                    </div>
                                `).join('') : '<p class="text-center text-neutral-700 italic text-[11px] py-4">아직 투표 데이터가 없습니다.</p>'}
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button onclick="state.step = '${AppState.WELCOME}'; render();" class="flex-grow bg-neutral-800 hover:bg-neutral-700 py-5 rounded-2xl font-black text-xs transition-all uppercase tracking-widest">메인으로</button>
                            <button onclick="resetAll()" class="px-6 bg-red-900/20 text-red-500 py-5 rounded-2xl font-black text-[10px] border border-red-900/30 uppercase tracking-widest">초기화</button>
                        </div>
                    </div>
                `;
            }

            if (state.step === AppState.FINAL_RESULT) {
                return `
                    <div class="space-y-10 animate-in duration-1000 flex-grow py-4">
                        <div class="text-center">
                            <div class="inline-block px-4 py-1 bg-red-600 rounded-full text-[10px] font-black uppercase mb-3 shadow-lg shadow-red-900/30 tracking-widest animate-pulse">Mission Accomplished</div>
                            <h2 class="text-4xl font-black tracking-tighter">최종 회식 장소 확정</h2>
                        </div>

                        <div class="bg-gradient-to-br from-orange-600 to-red-600 rounded-[3.5rem] p-12 text-center shadow-2xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-black opacity-10 group-hover:opacity-20 transition-opacity"></div>
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
                            <h3 class="text-5xl font-black mb-12 relative z-10 text-white drop-shadow-2xl tracking-tighter">${winner.name}</h3>
                            <a href="${winner.url}" target="_blank" class="inline-flex items-center gap-3 bg-white text-orange-600 px-10 py-5 rounded-[2rem] font-black hover:bg-orange-50 transition-all shadow-2xl relative z-10 active:scale-95 group-hover:px-12">
                                <i class="fas fa-map-marked-alt text-xl"></i> 길 찾기 (네이버)
                            </a>
                        </div>

                        <div class="bg-neutral-800/40 p-8 rounded-[2.5rem] border border-neutral-800 relative shadow-inner">
                            <div class="flex items-center gap-2 mb-6">
                                <div class="w-1.5 h-4 bg-orange-500 rounded-full"></div>
                                <h5 class="text-[10px] font-black text-orange-500 uppercase tracking-[0.3em]">AI 원정대장 분석 리포트</h5>
                            </div>
                            ${state.loadingAi ? `
                                <div class="space-y-4">
                                    <div class="h-3 bg-neutral-800 rounded-full w-full animate-pulse"></div>
                                    <div class="h-3 bg-neutral-800 rounded-full w-5/6 animate-pulse"></div>
                                    <div class="h-3 bg-neutral-800 rounded-full w-4/6 animate-pulse"></div>
                                </div>
                            ` : `
                                <p class="text-[15px] text-neutral-300 font-bold leading-relaxed whitespace-pre-wrap">${state.aiCommentary || '분석 중...'}</p>
                            `}
                        </div>

                        <div class="pt-4">
                            <button onclick="state.step = '${AppState.DASHBOARD}'; render();" class="w-full text-neutral-700 hover:text-orange-500 text-[10px] font-black uppercase py-4 transition-all tracking-[0.3em] border-t border-neutral-900">상세 투표 결과 분석표</button>
                        </div>
                    </div>
                `;
            }
        }

        function toggleDashboard() {
            state.step = state.step === AppState.DASHBOARD ? AppState.WELCOME : AppState.DASHBOARD;
            render();
        }

        // Storage 이벤트 리스너 (다른 탭 동기화)
        window.addEventListener('storage', function(e) {
            if (e.key === STORAGE_KEY) {
                loadVotes();
                render();
            }
        });

        // 초기 실행
        window.onload = function() {
            loadVotes();
            render();
        };
    </script>
</body>
</html>
